<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.6//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_6.dtd'>
<nta>
	<declaration>
    // Global clocks
    clock globalClock;

    // Channels
    broadcast chan callUp, callDown, requestMove, stopMove, arrivedFloor;

    // Elevator floor variable
    int floor = 0; // 0 as ground, range allowed: -1..3

    // Track if passenger calls
    bool callPlacedUp = false;
    bool callPlacedDown = false;
    bool reachedDestination = false;

    // Invariants to ensure floor is always within [-1..3]
    const int MIN_FLOOR = -1;
    const int MAX_FLOOR = 3;
  </declaration>
	<template>
		<name>Elevator</name>
		<declaration>
      // Local states to handle movement and idle
      bool moving = false;
    </declaration>
		<location id="id0" x="-238" y="85">
			<name x="-248" y="55">Idle</name>
		</location>
		<location id="id1" x="195" y="76">
			<name x="226" y="64">Moving</name>
		</location>
		<init ref="id0"/>
		<transition id="id2">
			<source ref="id0"/>
			<target ref="id1"/>
			<label kind="synchronisation" x="-34" y="17">requestMove?</label>
			<label kind="assignment" x="25" y="93">moving = true</label>
		</transition>
		<transition id="id3">
			<source ref="id1"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="-34" y="51">stopMove?</label>
			<label kind="assignment" x="-42" y="119">moving = false</label>
		</transition>
		<transition id="id4">
			<source ref="id1"/>
			<target ref="id1"/>
			<label kind="guard" x="234" y="4">moving &amp;&amp; floor &lt; MAX_FLOOR</label>
			<label kind="synchronisation" x="98" y="-123">arrivedFloor!</label>
			<label kind="assignment" x="141" y="132">floor = floor + 1</label>
			<nail x="161" y="42"/>
			<nail x="136" y="59"/>
		</transition>
		<transition id="id5">
			<source ref="id1"/>
			<target ref="id1"/>
			<label kind="guard" x="132" y="-21">moving &amp;&amp; floor &gt; MIN_FLOOR</label>
			<label kind="synchronisation" x="98" y="4">arrivedFloor!</label>
			<label kind="assignment" x="132" y="115">floor = floor - 1</label>
			<nail x="175" y="38"/>
			<nail x="217" y="38"/>
		</transition>
	</template>
	<template>
		<name>Dispatcher</name>
		<declaration>
      // Dispatcher listens for calls and requests elevator movement
    </declaration>
		<location id="id6" x="42" y="93">
			<name x="61" y="30">Monitor</name>
		</location>
		<init ref="id6"/>
		<transition id="id7">
			<source ref="id6"/>
			<target ref="id6"/>
			<label kind="guard" x="-125" y="5">callPlacedUp</label>
			<label kind="synchronisation" x="95" y="106">requestMove!</label>
			<label kind="assignment" x="-15" y="149">callPlacedUp = false</label>
			<nail x="-17" y="68"/>
			<nail x="-25" y="102"/>
		</transition>
		<transition id="id8">
			<source ref="id6"/>
			<target ref="id6"/>
			<label kind="guard" x="-91" y="21">callPlacedDown</label>
			<label kind="synchronisation" x="112" y="47">requestMove!</label>
			<label kind="assignment" x="-57" y="191">callPlacedDown = false</label>
			<nail x="12" y="63"/>
			<nail x="68" y="68"/>
		</transition>
		<transition id="id9">
			<source ref="id6"/>
			<target ref="id6"/>
			<label kind="guard" x="-161" y="127">reachedDestination</label>
			<label kind="synchronisation" x="-146" y="196">stopMove!</label>
			<nail x="8" y="136"/>
			<nail x="68" y="136"/>
		</transition>
	</template>
	<template>
		<name>Passenger</name>
		<declaration>
      // Passenger can place up or down calls, then watch for arrival
    </declaration>
		<location id="id10" x="-93" y="68">
			<name x="-103" y="38">Waiting</name>
		</location>
		<location id="id11" x="190" y="80">
			<name x="180" y="50">Riding</name>
		</location>
		<location id="id12" x="190" y="230">
			<name x="180" y="200">Arrived</name>
		</location>
		<init ref="id10"/>
		<transition id="id13">
			<source ref="id10"/>
			<target ref="id11"/>
			<label kind="synchronisation" x="55" y="65">callUp!</label>
			<label kind="assignment" x="-25" y="110">callPlacedUp = true</label>
		</transition>
		<transition id="id14">
			<source ref="id10"/>
			<target ref="id11"/>
			<label kind="synchronisation" x="-17" y="34">callDown!</label>
			<label kind="assignment" x="170" y="93">callPlacedDown = true</label>
		</transition>
		<transition id="id15">
			<source ref="id11"/>
			<target ref="id12"/>
			<label kind="synchronisation" x="130" y="140">arrivedFloor?</label>
			<label kind="assignment" x="130" y="155">reachedDestination = true</label>
		</transition>
	</template>
	<system>
    // Instantiate processes
    E = Elevator();
    D = Dispatcher();
    P = Passenger();

    // Compose the system
    system E, D, P;
  </system>
	<queries>
		<query>
			<formula>A[] (callPlacedUp || callPlacedDown) imply (&lt;&gt; E.moving == true)</formula>
			<comment>every call is eventually serviced</comment>
		</query>
		<query>
			<formula>A[] (E.floor &gt;= MIN_FLOOR &amp;&amp; E.floor &lt;= MAX_FLOOR)</formula>
			<comment>goes within floor -1 to 3</comment>
		</query>
		<query>
			<formula>A[] (P.riding) --&gt; (&lt;&gt; P.arrived)</formula>
			<comment>passenger eventually reaches the floor</comment>
		</query>
	</queries>
</nta>
